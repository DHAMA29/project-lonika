<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Global Function Access</title>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
            rel="stylesheet"
        />
        <style>
            .test-container {
                max-width: 900px;
                margin: 20px auto;
            }
            .d-none {
                display: none !important;
            }
            #console-output {
                background: #f8f9fa;
                padding: 15px;
                margin: 20px 0;
                border-radius: 8px;
                max-height: 400px;
                overflow-y: auto;
                font-family: monospace;
                font-size: 12px;
            }
            .success {
                color: green;
                font-weight: bold;
            }
            .error {
                color: red;
                font-weight: bold;
            }
            .info {
                color: blue;
            }
            .debug {
                color: orange;
            }
        </style>
    </head>
    <body>
        <div class="test-container">
            <h1>Test Global Function Access</h1>
            <p>
                Testing if window.filterProductsByCategory is accessible from
                event delegation
            </p>

            <!-- Function availability test -->
            <div class="mb-3">
                <h5>Function Availability Test:</h5>
                <button
                    class="btn btn-info"
                    onclick="testFunctionAvailability()"
                >
                    Test Functions
                </button>
            </div>

            <!-- Category filter test -->
            <div class="mb-3">
                <h5>Category Filter Test:</h5>
                <div class="d-flex flex-wrap gap-2">
                    <input
                        type="radio"
                        class="btn-check"
                        name="categoryFilter"
                        id="all"
                        autocomplete="off"
                        checked
                    />
                    <label class="btn btn-outline-primary btn-sm" for="all"
                        >Semua</label
                    >

                    <input
                        type="radio"
                        class="btn-check"
                        name="categoryFilter"
                        id="category-1"
                        autocomplete="off"
                    />
                    <label
                        class="btn btn-outline-primary btn-sm"
                        for="category-1"
                        >Elektronik</label
                    >

                    <input
                        type="radio"
                        class="btn-check"
                        name="categoryFilter"
                        id="category-2"
                        autocomplete="off"
                    />
                    <label
                        class="btn btn-outline-primary btn-sm"
                        for="category-2"
                        >Furniture</label
                    >

                    <button
                        type="button"
                        class="btn btn-outline-secondary btn-sm"
                        onclick="loadMoreCategories()"
                    >
                        <span>+2 lainnya</span>
                        <i class="fas fa-chevron-down ms-1"></i>
                    </button>
                </div>
            </div>

            <!-- Container for dynamically loaded categories -->
            <div id="moreCategoriesContainer" class="d-none mb-3">
                <h5>Dynamically Loaded Categories:</h5>
                <div class="d-flex flex-wrap gap-2" id="moreCategoriesContent">
                    <!-- Categories will be loaded here -->
                </div>
            </div>

            <!-- Console output -->
            <div id="console-output">
                <div class="info">Console output will appear here...</div>
            </div>

            <div class="mt-3">
                <button class="btn btn-secondary" onclick="clearConsole()">
                    Clear Console
                </button>
                <button class="btn btn-warning" onclick="testEventDelegation()">
                    Test Event Delegation
                </button>
            </div>
        </div>

        <script>
            // Console redirect
            function addToConsole(message, type = "info") {
                const consoleDiv = document.getElementById("console-output");
                const timestamp = new Date().toLocaleTimeString();
                consoleDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;

            console.log = function (...args) {
                originalConsoleLog.apply(console, arguments);
                addToConsole(args.join(" "), "info");
            };

            console.error = function (...args) {
                originalConsoleError.apply(console, arguments);
                addToConsole(args.join(" "), "error");
            };

            // === REPLICATE GLOBAL FUNCTIONS FROM REAL CODE ===

            // Global functions (exact replicas)
            window.filterProductsByCategory = function (categoryId) {
                console.log("=== FILTER FUNCTION CALLED ===");
                console.log("Category ID:", categoryId);

                addToConsole(
                    `✅ SUCCESS: window.filterProductsByCategory("${categoryId}") executed`,
                    "success"
                );
                addToConsole(
                    `✅ Would navigate to: /peminjaman/filter/category/${categoryId}`,
                    "success"
                );

                return true;
            };

            window.updatePageInfo = function (categoryName, productCount) {
                console.log(
                    "updatePageInfo called:",
                    categoryName,
                    productCount
                );
                addToConsole(
                    `✅ updatePageInfo: ${categoryName} (${productCount} products)`,
                    "success"
                );
            };

            window.showErrorMessage = function (message) {
                console.log("showErrorMessage called:", message);
                addToConsole(`✅ showErrorMessage: ${message}`, "success");
            };

            window.initializeProductCards = function () {
                console.log("initializeProductCards called");
                addToConsole(`✅ initializeProductCards executed`, "success");
            };

            // Global function for setting up AJAX category filters (exact copy)
            window.setupAjaxCategoryFilters = function () {
                console.log("Setting up AJAX category filters...");

                // Remove any existing event listeners
                $(document).off(
                    "change.ajaxFilter",
                    'input[name="categoryFilter"]'
                );

                // Use event delegation to handle both existing and future category buttons
                $(document).on(
                    "change.ajaxFilter",
                    'input[name="categoryFilter"]',
                    function () {
                        const selectedCategory = $(this).attr("id");
                        console.log(
                            "Category filter changed to:",
                            selectedCategory
                        );
                        console.log("Element that triggered change:", this);

                        // Extract category ID from the input ID
                        let categoryId = "all";
                        if (selectedCategory !== "all") {
                            categoryId = selectedCategory.replace(
                                "category-",
                                ""
                            );
                        }

                        console.log("Extracted category ID:", categoryId);
                        console.log(
                            "About to call window.filterProductsByCategory with:",
                            categoryId
                        );

                        // Call AJAX filter
                        window.filterProductsByCategory(categoryId);
                    }
                );

                console.log(
                    "AJAX category filters setup complete with event delegation"
                );
            };

            // Test functions
            function testFunctionAvailability() {
                addToConsole("=== TESTING FUNCTION AVAILABILITY ===", "debug");

                const functions = [
                    "filterProductsByCategory",
                    "updatePageInfo",
                    "showErrorMessage",
                    "initializeProductCards",
                    "setupAjaxCategoryFilters",
                ];

                functions.forEach((funcName) => {
                    if (typeof window[funcName] === "function") {
                        addToConsole(
                            `✅ window.${funcName} is available`,
                            "success"
                        );
                    } else {
                        addToConsole(
                            `✗ window.${funcName} is NOT available`,
                            "error"
                        );
                    }
                });

                // Test direct call
                try {
                    window.filterProductsByCategory("test");
                    addToConsole(
                        `✅ Direct call to window.filterProductsByCategory works`,
                        "success"
                    );
                } catch (error) {
                    addToConsole(
                        `✗ Direct call failed: ${error.message}`,
                        "error"
                    );
                }
            }

            function clearConsole() {
                document.getElementById("console-output").innerHTML =
                    '<div class="info">Console cleared...</div>';
            }

            function testEventDelegation() {
                addToConsole("=== TESTING EVENT DELEGATION ===", "debug");

                // Test existing elements
                addToConsole("Testing existing category buttons...", "debug");
                $("#category-1").prop("checked", true).trigger("change");

                // Test if dynamically loaded elements work
                setTimeout(() => {
                    addToConsole(
                        "Testing dynamically loaded elements...",
                        "debug"
                    );
                    if ($("#category-3").length > 0) {
                        $("#category-3")
                            .prop("checked", true)
                            .trigger("change");
                    } else {
                        addToConsole(
                            "Dynamic elements not loaded yet. Load categories first.",
                            "debug"
                        );
                    }
                }, 1000);
            }

            function loadMoreCategories() {
                const container = document.getElementById(
                    "moreCategoriesContainer"
                );
                const content = document.getElementById(
                    "moreCategoriesContent"
                );

                console.log("Loading more categories...");

                // Simulate the HTML that would be returned from server
                const simulatedHtml = `
                <input type="radio" class="btn-check" name="categoryFilter" id="category-3" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="category-3">Audio Visual</label>
                
                <input type="radio" class="btn-check" name="categoryFilter" id="category-4" autocomplete="off">
                <label class="btn btn-outline-primary btn-sm" for="category-4">Medis</label>
            `;

                content.innerHTML = simulatedHtml;
                container.classList.remove("d-none");

                console.log(
                    "Categories loaded successfully. Event delegation should handle new buttons."
                );
                addToConsole(
                    "✅ Dynamic categories loaded. Try clicking them!",
                    "success"
                );
            }

            // Initialize
            $(document).ready(function () {
                console.log("Document ready - initializing test");

                // Setup event delegation
                window.setupAjaxCategoryFilters();

                addToConsole(
                    "✅ Event delegation initialized with global functions",
                    "success"
                );
                addToConsole("Instructions:", "debug");
                addToConsole(
                    '1. Click "Test Functions" to verify all functions are available',
                    "debug"
                );
                addToConsole(
                    "2. Click any category button to test filtering",
                    "debug"
                );
                addToConsole(
                    '3. Click "lainnya" to load dynamic categories',
                    "debug"
                );
                addToConsole(
                    "4. Click dynamic category buttons to verify they work",
                    "debug"
                );

                // Auto-test function availability
                setTimeout(testFunctionAvailability, 500);
            });
        </script>
    </body>
</html>
